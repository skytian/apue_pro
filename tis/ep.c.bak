/*************************************************************************
	> File Name: ep.c
	> Author: 
	> Mail: 
	> Created Time: 2017年03月09日 星期四 19时14分30秒
 ************************************************************************/

#include<stdio.h>
#include<sys/epoll.h>
#include<sys/types.h>
#include<sys/socket.h>
#include<netinet/in.h>
#include<arpa/inet.h>
#include<string.h>
#include<unistd.h>
#include<stdlib.h>
#include<errno.h>

#define MAXFD   1024
#define MAXLINE 1024
#define PORT    8080


int main(){
    int ev_fd, ser_fd, con_fd;
    int rev_size = 0;
    char buf[MAXLINE];
    socklen_t slen;
    struct sockaddr_in ser_addr, cli_addr;

    bzero(&ser_addr, sizeof(ser_addr));
    ser_addr.sin_family = AF_INET;
    ser_addr.sin_addr.s_addr = INADDR_ANY;
    ser_addr.sin_port = htons(PORT);

    if((ser_fd = socket(AF_INET, SOCK_STREAM, 0)) < 0){
        perror("socket error!\n");
        exit(1);
    }

    if(bind(ser_fd, (struct sockaddr *)&ser_addr, sizeof(ser_addr))< 0){
        perror("bind error!");
        exit(1);
    }

    if(listen(ser_fd, 10) < 0){
        perror("listen error!");
        exit(1);
    }

    slen = sizeof(cli_addr);
    while(1){
        if((con_fd = accept(ser_fd, (struct sockaddr *)&cli_addr, &slen)) < 0){
            printf("con_fd:%d", con_fd);
            perror("accept error! con_fd\n");
            exit(1);
        }
        else{
            while((rev_size = read(con_fd, buf, MAXLINE)) > 0){
                buf[rev_size] = '\0';
                printf("receive buf:%s rev_size:%d from client:%s!\n", buf, rev_size, inet_ntoa(cli_addr.sin_addr));
                write(con_fd, buf, strlen(buf)+1);
            }
        }
    }
}
